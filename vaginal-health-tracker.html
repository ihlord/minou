<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a0a2e">
<title>Minou ‚Äî Health Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0618;
    --surface: #160d26;
    --surface2: #1e1235;
    --border: rgba(255,255,255,0.08);
    --accent: #c084fc;
    --accent2: #f0abfc;
    --accent3: #86efac;
    --text: #f3e8ff;
    --muted: rgba(243,232,255,0.45);
    --danger: #f87171;
    --radius: 16px;
    --font-body: 'Cormorant Garamond', Georgia, serif;
    --font-mono: 'DM Mono', monospace;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-body);
    font-size: 18px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 40% at 20% 10%, rgba(192,132,252,0.12) 0%, transparent 70%),
      radial-gradient(ellipse 40% 60% at 80% 80%, rgba(134,239,172,0.06) 0%, transparent 70%),
      radial-gradient(ellipse 80% 30% at 50% 50%, rgba(240,171,252,0.04) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
  #auth-screen {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 24px;
  }

  .auth-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 48px 36px;
    width: 100%;
    max-width: 380px;
    text-align: center;
    backdrop-filter: blur(20px);
    box-shadow: 0 40px 80px rgba(0,0,0,0.5), 0 0 0 1px rgba(192,132,252,0.1);
  }

  .auth-logo {
    font-size: 48px;
    margin-bottom: 8px;
  }

  .auth-title {
    font-size: 32px;
    font-weight: 300;
    letter-spacing: 0.08em;
    color: var(--accent2);
    margin-bottom: 6px;
  }

  .auth-subtitle {
    font-size: 14px;
    font-family: var(--font-mono);
    color: var(--muted);
    margin-bottom: 36px;
    letter-spacing: 0.05em;
  }

  .auth-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 18px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 15px;
    margin-bottom: 12px;
    outline: none;
    transition: border-color 0.2s;
  }

  .auth-input:focus { border-color: var(--accent); }
  .auth-input::placeholder { color: var(--muted); }

  .auth-btn {
    width: 100%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 12px;
    padding: 15px;
    color: #1a0a2e;
    font-family: var(--font-mono);
    font-size: 14px;
    font-weight: 400;
    letter-spacing: 0.1em;
    cursor: pointer;
    margin-top: 8px;
    transition: opacity 0.2s, transform 0.1s;
  }

  .auth-btn:active { opacity: 0.8; transform: scale(0.98); }

  .auth-toggle {
    margin-top: 20px;
    font-size: 14px;
    font-family: var(--font-mono);
    color: var(--muted);
  }

  .auth-toggle a {
    color: var(--accent);
    cursor: pointer;
    text-decoration: none;
  }

  .auth-error {
    background: rgba(248,113,113,0.1);
    border: 1px solid rgba(248,113,113,0.3);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 13px;
    font-family: var(--font-mono);
    color: var(--danger);
    margin-bottom: 12px;
    display: none;
  }

  /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
  #app { display: none; position: relative; z-index: 1; }

  .top-bar {
    position: sticky;
    top: 0;
    z-index: 50;
    background: rgba(14,6,24,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .top-bar-title {
    font-size: 22px;
    font-weight: 300;
    letter-spacing: 0.1em;
    color: var(--accent2);
  }

  .top-bar-actions { display: flex; gap: 12px; align-items: center; }

  .icon-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 12px;
    color: var(--muted);
    font-size: 13px;
    font-family: var(--font-mono);
    cursor: pointer;
    transition: color 0.2s, border-color 0.2s;
  }
  .icon-btn:hover { color: var(--text); border-color: var(--accent); }

  /* ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ */
  .calendar-section { padding: 24px 20px 12px; }

  .month-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .month-label {
    font-size: 26px;
    font-weight: 300;
    letter-spacing: 0.06em;
    color: var(--text);
  }

  .month-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    width: 40px;
    height: 40px;
    color: var(--text);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }
  .month-btn:hover { background: var(--surface2); }

  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  .cal-dow {
    text-align: center;
    font-family: var(--font-mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.08em;
    padding: 4px 0 8px;
  }

  .cal-day {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    cursor: pointer;
    position: relative;
    transition: background 0.15s;
    border: 1px solid transparent;
  }

  .cal-day:hover { background: var(--surface2); }

  .cal-day.today {
    border-color: var(--accent);
    color: var(--accent2);
  }

  .cal-day.selected {
    background: linear-gradient(135deg, rgba(192,132,252,0.2), rgba(240,171,252,0.1));
    border-color: var(--accent);
  }

  .cal-day.has-data::after {
    content: '';
    position: absolute;
    bottom: 4px;
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--accent3);
  }

  .cal-day.empty { cursor: default; }

  .cal-day-num {
    font-size: 15px;
    font-family: var(--font-mono);
    line-height: 1;
  }

  /* ‚îÄ‚îÄ LOG PANEL ‚îÄ‚îÄ */
  .log-panel {
    margin: 12px 20px 100px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .log-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .log-date {
    font-size: 20px;
    font-weight: 300;
    letter-spacing: 0.05em;
    color: var(--accent2);
  }

  .save-btn {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 10px;
    padding: 10px 20px;
    color: #1a0a2e;
    font-family: var(--font-mono);
    font-size: 13px;
    font-weight: 400;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .save-btn:active { opacity: 0.8; }

  .log-body { padding: 8px 0; }

  .section-title {
    padding: 18px 24px 8px;
    font-family: var(--font-mono);
    font-size: 11px;
    letter-spacing: 0.15em;
    color: var(--accent);
    text-transform: uppercase;
  }

  .field-row {
    padding: 10px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .field-label {
    flex: 0 0 130px;
    font-size: 16px;
    color: var(--muted);
    font-weight: 300;
  }

  .field-control { flex: 1; }

  /* Selects */
  select {
    appearance: none;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 16px;
    width: 100%;
    outline: none;
    cursor: pointer;
  }
  select:focus { border-color: var(--accent); }

  /* Toggle */
  .toggle-wrap {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .toggle-chip {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--muted);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s;
    font-family: var(--font-body);
  }
  .toggle-chip.active {
    background: rgba(192,132,252,0.15);
    border-color: var(--accent);
    color: var(--accent2);
  }

  /* Slider */
  .slider-wrap { display: flex; align-items: center; gap: 12px; }

  input[type=range] {
    flex: 1;
    -webkit-appearance: none;
    height: 4px;
    background: var(--surface2);
    border-radius: 2px;
    outline: none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 0 8px rgba(192,132,252,0.5);
  }

  .slider-val {
    font-family: var(--font-mono);
    font-size: 15px;
    color: var(--accent2);
    min-width: 28px;
    text-align: center;
  }

  /* Text area */
  textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    color: var(--text);
    font-family: var(--font-body);
    font-size: 16px;
    resize: none;
    outline: none;
    min-height: 80px;
  }
  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--muted); }

  .notes-wrap { padding: 12px 24px 20px; }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface2);
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 12px 24px;
    font-family: var(--font-mono);
    font-size: 13px;
    color: var(--accent2);
    opacity: 0;
    transition: all 0.3s;
    z-index: 200;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Loading */
  .loading {
    text-align: center;
    padding: 40px;
    font-family: var(--font-mono);
    font-size: 13px;
    color: var(--muted);
  }

  /* Config screen */
  #config-screen {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 200;
    overflow-y: auto;
    padding: 24px;
  }

  .config-card {
    max-width: 500px;
    margin: 0 auto;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 36px;
  }

  .config-title {
    font-size: 24px;
    font-weight: 300;
    color: var(--accent2);
    margin-bottom: 8px;
    letter-spacing: 0.06em;
  }

  .config-desc {
    font-size: 14px;
    font-family: var(--font-mono);
    color: var(--muted);
    line-height: 1.7;
    margin-bottom: 28px;
  }

  .config-label {
    display: block;
    font-family: var(--font-mono);
    font-size: 12px;
    letter-spacing: 0.1em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 8px;
    margin-top: 20px;
  }

  .config-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 14px;
    outline: none;
  }
  .config-input:focus { border-color: var(--accent); }

  .config-btn {
    width: 100%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border: none;
    border-radius: 12px;
    padding: 14px;
    color: #1a0a2e;
    font-family: var(--font-mono);
    font-size: 14px;
    letter-spacing: 0.08em;
    cursor: pointer;
    margin-top: 28px;
  }

  .config-note {
    font-size: 13px;
    font-family: var(--font-mono);
    color: var(--muted);
    margin-top: 16px;
    line-height: 1.6;
  }

  .config-note a { color: var(--accent); }

  .period-on { background: rgba(248,113,113,0.15) !important; border-color: #f87171 !important; color: #f87171 !important; }

  @media (max-width: 420px) {
    .field-label { flex: 0 0 100px; font-size: 14px; }
    .cal-day-num { font-size: 13px; }
  }
</style>
</head>
<body>

<!-- Config screen (first run) -->
<div id="config-screen">
  <div class="config-card">
    <div class="config-title">Welcome to Minou</div>
    <div class="config-desc">
      Before you begin, you need to connect your own Supabase database. This keeps your data private and synced across devices.<br><br>
      This is a one-time setup.
    </div>

    <div style="background:rgba(192,132,252,0.07);border:1px solid rgba(192,132,252,0.2);border-radius:12px;padding:20px;margin-bottom:8px;">
      <div style="font-family:var(--font-mono);font-size:12px;color:var(--accent);letter-spacing:0.1em;margin-bottom:12px;">SETUP STEPS</div>
      <ol style="font-family:var(--font-mono);font-size:13px;color:var(--muted);line-height:2;padding-left:18px;">
        <li>Go to <a href="https://supabase.com" target="_blank" style="color:var(--accent)">supabase.com</a> ‚Üí create free account</li>
        <li>Create a new project (any name)</li>
        <li>Go to <strong style="color:var(--text)">SQL Editor</strong> and run the SQL below</li>
        <li>Go to <strong style="color:var(--text)">Project Settings ‚Üí API</strong></li>
        <li>Copy your Project URL and anon key below</li>
      </ol>
    </div>

    <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin:16px 0;overflow-x:auto;">
      <pre style="font-family:var(--font-mono);font-size:11px;color:var(--muted);line-height:1.6;white-space:pre-wrap;">-- Run this in Supabase SQL Editor:

create table logs (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users not null,
  log_date date not null,
  data jsonb not null default '{}',
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  unique(user_id, log_date)
);

alter table logs enable row level security;

create policy "Users see own logs" on logs
  for all using (auth.uid() = user_id);
</pre>
    </div>

    <label class="config-label">Supabase Project URL</label>
    <input id="cfg-url" class="config-input" type="text" placeholder="https://xxxxxxxxxxxx.supabase.co">

    <label class="config-label">Supabase Anon Key</label>
    <input id="cfg-key" class="config-input" type="text" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">

    <button class="config-btn" onclick="saveConfig()">Save & Continue ‚Üí</button>

    <div class="config-note">
      Your data is stored in your own Supabase account. This app never sees your credentials ‚Äî they're stored in your browser only.
    </div>
  </div>
</div>

<!-- Auth screen -->
<div id="auth-screen" style="display:none">
  <div class="auth-card">
    <div class="auth-logo">üåø</div>
    <div class="auth-title">Minou</div>
    <div class="auth-subtitle">personal health journal</div>

    <div id="auth-error" class="auth-error"></div>

    <input id="auth-email" class="auth-input" type="email" placeholder="Email address" autocomplete="email">
    <input id="auth-password" class="auth-input" type="password" placeholder="Password" autocomplete="current-password">
    <button class="auth-btn" onclick="doAuth()" id="auth-submit">Sign in ‚Üí</button>

    <div class="auth-toggle">
      <span id="auth-toggle-text">No account?</span>
      <a onclick="toggleAuthMode()" id="auth-toggle-link"> Create one</a>
    </div>
  </div>
</div>

<!-- Main app -->
<div id="app">
  <div class="top-bar">
    <div class="top-bar-title">üåø Minou</div>
    <div class="top-bar-actions">
      <button class="icon-btn" onclick="signOut()">sign out</button>
    </div>
  </div>

  <div class="calendar-section">
    <div class="month-nav">
      <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
      <div class="month-label" id="month-label"></div>
      <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
  </div>

  <div class="log-panel">
    <div class="log-header">
      <div class="log-date" id="log-date-label">Select a day</div>
      <button class="save-btn" onclick="saveLog()">Save</button>
    </div>
    <div class="log-body" id="log-body">
      <div class="loading">‚Üê Select a date on the calendar</div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let SUPABASE_URL = localStorage.getItem('flora_url') || '';
let SUPABASE_KEY = localStorage.getItem('flora_key') || '';
let sbClient = null;
let authMode = 'signin';
let selectedDate = null;
let currentYear, currentMonth;
let loggedDates = new Set();
let currentLog = {};

const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS = ['Su','Mo','Tu','We','Th','Fr','Sa'];

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  const now = new Date();
  currentYear = now.getFullYear();
  currentMonth = now.getMonth();

  if (!SUPABASE_URL || !SUPABASE_KEY) {
    document.getElementById('config-screen').style.display = 'block';
    return;
  }

  initSupabase();
}

function initSupabase() {
  sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  checkSession();
}

function saveConfig() {
  const url = document.getElementById('cfg-url').value.trim();
  const key = document.getElementById('cfg-key').value.trim();
  if (!url || !key) { alert('Please fill in both fields.'); return; }
  localStorage.setItem('flora_url', url);
  localStorage.setItem('flora_key', key);
  SUPABASE_URL = url;
  SUPABASE_KEY = key;
  document.getElementById('config-screen').style.display = 'none';
  initSupabase();
}

async function checkSession() {
  const { data: { session } } = await sbClient.auth.getSession();
  if (session) {
    showApp();
  } else {
    document.getElementById('auth-screen').style.display = 'flex';
  }
}

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleAuthMode() {
  authMode = authMode === 'signin' ? 'signup' : 'signin';
  const isSignin = authMode === 'signin';
  document.getElementById('auth-submit').textContent = isSignin ? 'Sign in ‚Üí' : 'Create account ‚Üí';
  document.getElementById('auth-toggle-text').textContent = isSignin ? 'No account?' : 'Have an account?';
  document.getElementById('auth-toggle-link').textContent = isSignin ? ' Create one' : ' Sign in';
  document.getElementById('auth-error').style.display = 'none';
}

async function doAuth() {
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const errEl = document.getElementById('auth-error');
  errEl.style.display = 'none';

  if (!email || !password) { showAuthError('Please fill in all fields.'); return; }

  let result;
  if (authMode === 'signin') {
    result = await sbClient.auth.signInWithPassword({ email, password });
  } else {
    result = await sbClient.auth.signUp({ email, password });
  }

  if (result.error) {
    showAuthError(result.error.message);
  } else {
    document.getElementById('auth-screen').style.display = 'none';
    showApp();
  }
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = 'block';
}

async function signOut() {
  await sbClient.auth.signOut();
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
}

// ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function showApp() {
  document.getElementById('app').style.display = 'block';
  await loadMonthData();
  renderCalendar();
  // Auto-select today
  const today = toDateStr(new Date());
  selectDate(today);
}

function toDateStr(d) {
  return d.toISOString().split('T')[0];
}

async function loadMonthData() {
  const { data: { user } } = await sbClient.auth.getUser();
  if (!user) return;

  const firstDay = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-01`;
  const lastDay = new Date(currentYear, currentMonth+1, 0);
  const lastDayStr = toDateStr(lastDay);

  const { data } = await sbClient
    .from('logs')
    .select('log_date')
    .gte('log_date', firstDay)
    .lte('log_date', lastDayStr);

  loggedDates = new Set((data || []).map(r => r.log_date));
}

function renderCalendar() {
  document.getElementById('month-label').textContent = `${MONTHS[currentMonth]} ${currentYear}`;
  const grid = document.getElementById('cal-grid');
  grid.innerHTML = '';

  DAYS.forEach(d => {
    const el = document.createElement('div');
    el.className = 'cal-dow';
    el.textContent = d;
    grid.appendChild(el);
  });

  const firstDow = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
  const todayStr = toDateStr(new Date());

  for (let i = 0; i < firstDow; i++) {
    const el = document.createElement('div');
    el.className = 'cal-day empty';
    grid.appendChild(el);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const el = document.createElement('div');
    el.className = 'cal-day';
    if (dateStr === todayStr) el.classList.add('today');
    if (dateStr === selectedDate) el.classList.add('selected');
    if (loggedDates.has(dateStr)) el.classList.add('has-data');

    el.innerHTML = `<span class="cal-day-num">${d}</span>`;
    el.onclick = () => selectDate(dateStr);
    grid.appendChild(el);
  }
}

async function changeMonth(dir) {
  currentMonth += dir;
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  await loadMonthData();
  renderCalendar();
}

async function selectDate(dateStr) {
  selectedDate = dateStr;

  // Update calendar highlight
  document.querySelectorAll('.cal-day.selected').forEach(el => el.classList.remove('selected'));
  const todayStr = toDateStr(new Date());
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
  const firstDow = new Date(currentYear, currentMonth, 1).getDay();
  const [y, m, d] = dateStr.split('-').map(Number);
  if (y === currentYear && (m-1) === currentMonth) {
    const allDays = document.querySelectorAll('.cal-day:not(.empty)');
    const idx = d - 1;
    if (allDays[idx]) allDays[idx].classList.add('selected');
  }

  // Format date label
  const dt = new Date(dateStr + 'T12:00:00');
  document.getElementById('log-date-label').textContent = dt.toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'long', year:'numeric' });

  // Load log for date
  const { data: { user } } = await sbClient.auth.getUser();
  const { data } = await sbClient
    .from('logs')
    .select('data')
    .eq('user_id', user.id)
    .eq('log_date', dateStr)
    .maybeSingle();

  currentLog = (data && data.data) ? data.data : {};
  renderLogForm();
}

function renderLogForm() {
  const body = document.getElementById('log-body');
  const L = currentLog;

  body.innerHTML = `
    <!-- DISCHARGE -->
    <div class="section-title">Discharge</div>

    <div class="field-row">
      <div class="field-label">Colour</div>
      <div class="field-control">
        <select id="f-disc-colour" onchange="update('disc_colour',this.value)">
          <option value="">‚Äî</option>
          ${['Clear','White','Off-white','Yellow','Green','Grey','Brown','Pink','Red'].map(o=>`<option value="${o}" ${L.disc_colour===o?'selected':''}>${o}</option>`).join('')}
        </select>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Consistency</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['Watery','Creamy','Sticky','Stretchy','Clumpy','Thick','None'].map(o=>`<div class="toggle-chip ${L.disc_consistency===o?'active':''}" onclick="selectToggle('disc_consistency','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Amount</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['None','Spotting','Light','Moderate','Heavy'].map(o=>`<div class="toggle-chip ${L.disc_amount===o?'active':''}" onclick="selectToggle('disc_amount','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <!-- ODOUR -->
    <div class="section-title">Odour</div>
    <div class="field-row">
      <div class="field-label">Type</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['None','Mild','Musky','Fishy','Sweet','Metallic','Sour','Yeasty'].map(o=>`<div class="toggle-chip ${L.odour===o?'active':''}" onclick="selectToggle('odour','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <!-- IRRITATION & PH -->
    <div class="section-title">Irritation & pH</div>

    <div class="field-row">
      <div class="field-label">Itching</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['None','Mild','Moderate','Severe'].map(o=>`<div class="toggle-chip ${L.itching===o?'active':''}" onclick="selectToggle('itching','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Irritation</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['None','Mild','Moderate','Severe'].map(o=>`<div class="toggle-chip ${L.irritation===o?'active':''}" onclick="selectToggle('irritation','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">pH level</div>
      <div class="field-control">
        <input type="number" min="0" max="14" step="0.1"
          style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:var(--font-mono);font-size:16px;width:100px;outline:none;"
          value="${L.ph_level||''}" oninput="update('ph_level',this.value)" placeholder="e.g. 4.5">
      </div>
    </div>

    <!-- PAIN -->
    <div class="section-title">Pain</div>

    <div class="field-row">
      <div class="field-label">Severity</div>
      <div class="field-control">
        <div class="slider-wrap">
          <input type="range" min="0" max="10" step="1" value="${L.pain_severity||0}"
            oninput="update('pain_severity',parseInt(this.value));document.getElementById('pain-val').textContent=this.value">
          <div class="slider-val" id="pain-val">${L.pain_severity||0}</div>
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Location</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['Vulva','Internal','Lower abdomen','Lower back','Thighs','Multiple'].map(o=>`<div class="toggle-chip ${(L.pain_location||[]).includes(o)?'active':''}" onclick="toggleMulti('pain_location','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Type</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['Burning','Cramping','Stabbing','Aching','Pressure','Throbbing','Stinging'].map(o=>`<div class="toggle-chip ${(L.pain_type||[]).includes(o)?'active':''}" onclick="toggleMulti('pain_type','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Timing</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['During sex','After sex','Randomly','All day','Morning','Evening','During period'].map(o=>`<div class="toggle-chip ${(L.pain_timing||[]).includes(o)?'active':''}" onclick="toggleMulti('pain_timing','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <!-- MENSTRUAL -->
    <div class="section-title">Menstrual Cycle</div>

    <div class="field-row">
      <div class="field-label">Period</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['None','Spotting','Light','Moderate','Heavy','Very heavy'].map(o=>`<div class="toggle-chip ${L.period===o?'active':''} ${o!=='None'&&L.period===o?'period-on':''}" onclick="selectToggle('period','${o}',this,true)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Clots</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['None','Small','Large'].map(o=>`<div class="toggle-chip ${L.clots===o?'active':''}" onclick="selectToggle('clots','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <!-- SEXUAL ACTIVITY -->
    <div class="section-title">Sexual Activity</div>

    <div class="field-row">
      <div class="field-label">Activity</div>
      <div class="field-control">
        <div class="toggle-wrap">
          <div class="toggle-chip ${L.sex_activity?'active':''}" onclick="toggleBool('sex_activity',this)">Yes</div>
          <div class="toggle-chip ${L.sex_activity===false?'active':''}" onclick="update('sex_activity',false);document.querySelectorAll('.sex-active').forEach(e=>e.parentElement.classList.remove('active'))">No</div>
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Protection</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['Condom','Internal condom','None','Other'].map(o=>`<div class="toggle-chip ${L.sex_protection===o?'active':''}" onclick="selectToggle('sex_protection','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Partner</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['Regular','New','Solo','Multiple'].map(o=>`<div class="toggle-chip ${L.sex_partner===o?'active':''}" onclick="selectToggle('sex_partner','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <!-- MEDICATIONS -->
    <div class="section-title">Medications & Supplements</div>

    <div class="field-row">
      <div class="field-label">Antibiotics</div>
      <div class="field-control">
        <div class="toggle-wrap">
          <div class="toggle-chip ${L.med_antibiotics?'active':''}" onclick="boolToggle('med_antibiotics',this)">Yes</div>
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Probiotics</div>
      <div class="field-control">
        <div class="toggle-wrap">
          <div class="toggle-chip ${L.med_probiotics?'active':''}" onclick="boolToggle('med_probiotics',this)">Yes</div>
        </div>
      </div>
    </div>

    <div class="field-row">
      <div class="field-label">Other meds</div>
      <div class="field-control">
        <input type="text"
          style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:var(--font-body);font-size:16px;width:100%;outline:none;"
          value="${L.med_other||''}" oninput="update('med_other',this.value)" placeholder="e.g. fluconazole, metronidazole">
      </div>
    </div>

    <!-- MOOD -->
    <div class="section-title">Mood & Wellbeing</div>

    <div class="field-row">
      <div class="field-label">Overall mood</div>
      <div class="field-control">
        <div class="toggle-wrap">
          ${['üòä Good','üòê Neutral','üòî Low','üò† Irritable','üò∞ Anxious','üò¥ Tired'].map(o=>`<div class="toggle-chip ${L.mood===o?'active':''}" onclick="selectToggle('mood','${o}',this)">${o}</div>`).join('')}
        </div>
      </div>
    </div>

    <!-- NOTES -->
    <div class="section-title">Notes</div>
    <div class="notes-wrap">
      <textarea id="f-notes" placeholder="Any other observations, symptoms, or context‚Ä¶" oninput="update('notes',this.value)">${L.notes||''}</textarea>
    </div>
  `;
}

// ‚îÄ‚îÄ‚îÄ DATA HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function update(key, val) {
  currentLog[key] = val;
}

function selectToggle(key, val, el, periodStyle) {
  currentLog[key] = val;
  el.closest('.toggle-wrap').querySelectorAll('.toggle-chip').forEach(c => {
    c.classList.remove('active');
    if (periodStyle) c.classList.remove('period-on');
  });
  el.classList.add('active');
  if (periodStyle && val !== 'None') el.classList.add('period-on');
}

function toggleMulti(key, val, el) {
  if (!currentLog[key]) currentLog[key] = [];
  const idx = currentLog[key].indexOf(val);
  if (idx === -1) { currentLog[key].push(val); el.classList.add('active'); }
  else { currentLog[key].splice(idx, 1); el.classList.remove('active'); }
}

function boolToggle(key, el) {
  currentLog[key] = !currentLog[key];
  el.classList.toggle('active', currentLog[key]);
}

function toggleBool(key, el) {
  currentLog[key] = true;
  el.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveLog() {
  if (!selectedDate) { showToast('Please select a date first'); return; }

  const { data: { user } } = await sbClient.auth.getUser();

  const { error } = await sbClient
    .from('logs')
    .upsert({
      user_id: user.id,
      log_date: selectedDate,
      data: currentLog,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id,log_date' });

  if (error) {
    showToast('Error saving: ' + error.message);
  } else {
    loggedDates.add(selectedDate);
    renderCalendar();
    showToast('Saved ‚úì');
  }
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ‚îÄ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
